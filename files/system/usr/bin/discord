#!/usr/bin/bash
set -euo pipefail

OVERLAY_BIN="/opt/discord/Discord"
STOCK_BIN="/usr/share/discord/Discord"
SERVICE_NAME="discord-overlay.service"

# Check if /opt/discord is actually overlay-mounted
is_overlay_mounted() {
  findmnt -n -t overlay /opt/discord >/dev/null 2>&1
}

# Try to launch from overlay if everything is in place
try_overlay() {
  if is_overlay_mounted && [ -x "$OVERLAY_BIN" ]; then
    exec "$OVERLAY_BIN" "$@"
  fi
}

###############################################
# 1. First attempt — use overlay if it's ready
###############################################
try_overlay "$@"

###########################################################
# 2. If overlay isn't ready, try to start the systemd unit
###########################################################
if command -v systemctl >/dev/null 2>&1; then
  if systemctl is-enabled --quiet "$SERVICE_NAME" 2>/dev/null; then
    # Try starting the service, but don't die if it fails
    systemctl start "$SERVICE_NAME" || true
    sleep 0.5  # give it a moment to mount
    try_overlay "$@"
  fi
fi

###################################################
# 3. Fallback to stock Discord if overlay is dead
###################################################
if [ -x "$STOCK_BIN" ]; then
  exec "$STOCK_BIN" "$@"
fi

###################################################
# 4. Catastrophic fallback — nothing to run
###################################################
echo "discord-wrapper: No usable Discord binary found (overlay or stock)." >&2
exit 1
